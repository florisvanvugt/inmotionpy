# Notes about the robot code

This is a collection of random notes relating to the InMotion2 robot code.


I set up Doxygen to generate a number of documentation pages in HTML straight from the C source code.

```
make doc
```



## Messages and logs
You can find some messages from the robot in `dmesg`. 

Also, you can look in `/var/log/syslog` for a variety of messages.

But somehow this is not where the debug messages go.
Debug messages are generated by calling `dpr()` in `write.c`, which seems to write to some buffer.

When the buffer is flushed (`dpr_flush()`) the contents are written to a pipe using `rt_pipe_write()`. The pipe is `ob->eofifo`, which is created in `fifo.c`. It seems that when you create these pipes using `rt_pipe_create()` you can give it a particular name (in our case these look like `crob_in` or `crob_error` and they are defined in `pipes.h`). Xenomai will then create a symbolic link `/proc/xenomai/registry/pipes/NAME` (where `NAME` is the string identifier) to a node `/dev/rtp*`.

Indeed, for example the logging procedure works by monitoring `/proc/xenomai/registry/pipes/crob_out` and pushing it to a file.

When monitoring `/dev/rtp[0-5]` I see various messages on `/dev/rtp2` when I run the robot (and before it dies).

Eavesdropping is easy: `sudo cat /dev/rtp2 > ~/rob_rtp2.txt` but you just need to make sure that you cut that pipe and restart it prior to launching the robot, otherwise it can't open the pipe for writing.

This is the kind of thing I am getting on `rtp2` (note that I had set the debug level to 5, the higest, I believe).

```
^@arr sum = 1867345481
carr sum = -574826563
carr sum = 1294923759
carr sum = 1839425361
carr sum = -501817148
carr sum = 1429687849
carr sum = -861162344
carr sum = -317643015
carr sum = 226727519
carr sum = 1993337521
carr sum = -2125963233
carr sum = -172895626
carr sum = 371210218
carr sum = 1463857484
carr sum = -1129114182
carr sum = 503789105
carr sum = -1939037025
carr sum = -102627839
carr sum = 1764036619
carr sum = -761820805
carr sum = -217320990
carr sum = 641475092
carr sum = -1700107468
carr sum = -32776807
carr sum = 1669482253
carr sum = -672033747
carr sum = -127925354
carr sum = 1623419114
carr sum = -802170792
carr sum = 1133855167
carr sum = -1310826005
carr sum = -186085298
carr sum = 1732967855
carr sum = -860724712
carr sum = 234848836
carr sum = 1632936560
carr sum = -709055311
carr sum = 83303717
carr sum = 2087621716
carr sum = -253952638
carr sum = 1413378023
carr sum = -1179330213
carr sum = 774129288
carr sum = 1553118705
carr sum = 1728062804
carr sum = -2022927979
carr sum = -271320313
carr sum = 1643409019
carr sum = -732306976
carr sum = -557955242
carr sum = -557955232
return from main_init
Starting robot realtime process.
main: calling pthread_create start_routine
start_routine: top of thread, 400 Hz
main_loop: top, i = 0, samples = 0, time since start = 0 ms
do_time_before_sample
check_late
check_late: assert not busy
check_late: warning: slow tick.  time = 1435 ms, i = 0 ticks
        tick took 1435106589 ns > threshold (120%)
call_read_sensors
call_read_reference
compute_controls
call_check_safety
do_time_after_sample
after_sample: warning: slow sample.  time = 1435 ms, i = 0 ticks
        sample took 1793877800 ns, > threshold (10%)
		
```


First of all, I have no idea what these `carr sum` statements are for. I can't see that `carr` is used anywhere else.

Second, it seems that the robot finds that its main loop is too slow, perhaps this is why it quits?





This is curious because Xenomai itself appears to be working properly, with microsecond resolution.

```
== Sampling period: 100 us
== Test mode: periodic user-mode task
== All results in microseconds
warming up...
RTT|  00:00:01  (periodic user-mode task, 100 us period, priority 99)
RTH|----lat min|----lat avg|----lat max|-overrun|---msw|---lat best|--lat worst
RTD|      1.037|      1.053|      1.831|       0|     0|      1.037|      1.831
RTD|      0.695|      1.000|      1.777|       0|     0|      0.695|      1.831
RTD|      0.964|      1.046|      1.783|       0|     0|      0.695|      1.831
RTD|      0.784|      1.028|      1.726|       0|     0|      0.695|      1.831
RTD|      0.962|      1.044|      1.836|       0|     0|      0.695|      1.836
RTD|      0.830|      1.025|      1.852|       0|     0|      0.695|      1.852
RTD|      0.962|      1.009|      1.825|       0|     0|      0.695|      1.852
RTD|      0.828|      1.025|      2.113|       0|     0|      0.695|      2.113
RTD|      0.962|      1.038|      1.798|       0|     0|      0.695|      2.113
RTD|      0.827|      1.050|      1.830|       0|     0|      0.695|      2.113
RTD|      0.965|      1.036|      1.875|       0|     0|      0.695|      2.113
RTD|      0.861|      1.017|      1.758|       0|     0|      0.695|      2.113
RTD|      0.964|      1.024|      1.831|       0|     0|      0.695|      2.113
RTD|      0.829|      1.045|      1.790|       0|     0|      0.695|      2.113
RTD|      0.963|      1.045|      1.782|       0|     0|      0.695|      2.113
RTD|      0.842|      1.044|      1.783|       0|     0|      0.695|      2.113
RTD|      0.962|      1.027|      1.818|       0|     0|      0.695|      2.113
RTD|      0.960|      1.009|      2.151|       0|     0|      0.695|      2.151
RTD|      0.967|      1.051|      1.826|       0|     0|      0.695|      2.151
RTD|      0.867|      1.041|      1.725|       0|     0|      0.695|      2.151
RTD|      0.964|      1.054|      1.781|       0|     0|      0.695|      2.151
RTT|  00:00:22  (periodic user-mode task, 100 us period, priority 99)
RTH|----lat min|----lat avg|----lat max|-overrun|---msw|---lat best|--lat worst
RTD|      0.965|      1.046|      2.097|       0|     0|      0.695|      2.151
RTD|      0.966|      1.043|      1.808|       0|     0|      0.695|      2.151
RTD|      0.847|      1.011|      3.048|       0|     0|      0.695|      3.048
RTD|      0.964|      1.045|      1.844|       0|     0|      0.695|      3.048
RTD|      0.828|      1.027|      1.774|       0|     0|      0.695|      3.048
RTD|      0.965|      1.044|      1.828|       0|     0|      0.695|      3.048
RTD|      0.850|      1.032|      1.819|       0|     0|      0.695|      3.048
RTD|      0.959|      1.007|      1.910|       0|     0|      0.695|      3.048
RTD|      0.752|      0.996|      1.818|       0|     0|      0.695|      3.048
RTD|      0.952|      1.040|      2.709|       0|     0|      0.695|      3.048
RTD|      0.827|      1.050|      1.803|       0|     0|      0.695|      3.048
RTD|      0.962|      1.035|      1.877|       0|     0|      0.695|      3.048
RTD|      0.865|      1.044|      1.837|       0|     0|      0.695|      3.048
RTD|      0.962|      1.014|      2.188|       0|     0|      0.695|      3.048
RTD|      0.860|      1.045|      1.877|       0|     0|      0.695|      3.048
RTD|      0.960|      1.025|      1.791|       0|     0|      0.695|      3.048
RTD|      0.852|      1.043|      1.850|       0|     0|      0.695|      3.048
RTD|      0.964|      1.026|      1.830|       0|     0|      0.695|      3.048
^C---|-----------|-----------|-----------|--------|------|-------------------------
RTS|      0.695|      1.033|      3.048|       0|     0|    00:00:39/00:00:39
```







## Why the robot process stops

I think I found the reason why the robot process kills itself. From within `fifo.c` it appears that `rt_pipe_read()` experiences an error and then calls `cleanup_signal(0)` which quits the robot.
This is the error message corresponding to this (from `/var/log/syslog`), when I added the call:

```
Mar 23 16:19:16 suzuki imt-robot[6101]: fifo.c:145 -3 return from rt_pipe_read()
```

The error code is part of [Linux System Errors](http://www-numi.fnal.gov/offline_software/srt_public_context/WebDocs/Errors/unix_system_errors.html).




The anatomy of what happens (from `/var/log/syslog`):

```
Mar 23 16:45:17 suzuki imt-robot[6482]: -- Initialising the robot.
Mar 23 16:45:17 suzuki imt-robot[6482]: Cleaned up FIFOs (cleanup_fifos)
Mar 23 16:45:17 suzuki imt-robot[6482]: init_fifos: done
Mar 23 16:45:17 suzuki imt-robot[6482]: Starting robot realtime process.
Mar 23 16:45:17 suzuki imt-robot[6482]: Process id of child process 6483 
Mar 23 16:45:17 suzuki kernel: [ 4058.439180] Xenomai: native: cleaning up pipe "crob_in" (ret=0).
Mar 23 16:45:17 suzuki kernel: [ 4058.439197] Xenomai: native: cleaning up pipe "crob_out" (ret=0).
Mar 23 16:45:17 suzuki kernel: [ 4058.439243] Xenomai: native: cleaning up pipe "crob_error" (ret=0).
Mar 23 16:45:17 suzuki kernel: [ 4058.439249] Xenomai: native: cleaning up pipe "crob_cmd_in" (ret=0).
Mar 23 16:45:17 suzuki kernel: [ 4058.439255] Xenomai: native: cleaning up pipe "crob_display_out" (ret=0).
Mar 23 16:45:17 suzuki kernel: [ 4058.439261] Xenomai: native: cleaning up pipe "crob_tick" (ret=0).
Mar 23 16:45:17 suzuki imt-robot[6483]: fifo.c:149 -3 return from rt_pipe_read()
Mar 23 16:45:17 suzuki imt-robot[6483]: Cleaned up FIFOs (cleanup_fifos)
Mar 23 16:45:17 suzuki imt-robot[6483]: Stopping robot realtime process (got signal 0).
Mar 23 16:45:17 suzuki imt-robot[6483]: Exited the child.
```

Somehow Xenomai seems to have unilaterally decided to clean up the pipes? *UPDATE* No, this seems incorrect. When I changed the `POOLSIZE` to equal `FIFOLEN` in `fifo.c` then now the Xenomai clean up messages appear *after* the child has exited.


```
Mar 23 17:14:38 suzuki imt-robot[7131]: -- Initialising the robot.
Mar 23 17:14:38 suzuki imt-robot[7131]: Cleaned up FIFOs (cleanup_fifos)
Mar 23 17:14:38 suzuki imt-robot[7131]: init_fifos: done
Mar 23 17:14:38 suzuki imt-robot[7131]: Starting robot realtime process.
Mar 23 17:14:38 suzuki imt-robot[7131]: Process id of child process 7132 
Mar 23 17:14:38 suzuki imt-robot[7132]: fifo.c:149 -3 return from rt_pipe_read()
Mar 23 17:14:38 suzuki imt-robot[7132]: Cleaned up FIFOs (cleanup_fifos)
Mar 23 17:14:38 suzuki imt-robot[7132]: Stopping robot realtime process (got signal 0).
Mar 23 17:14:38 suzuki imt-robot[7132]: Exited the child.
Mar 23 17:14:38 suzuki kernel: [ 5819.093077] Xenomai: native: cleaning up pipe "crob_in" (ret=0).
Mar 23 17:14:38 suzuki kernel: [ 5819.093089] Xenomai: native: cleaning up pipe "crob_out" (ret=0).
Mar 23 17:14:38 suzuki kernel: [ 5819.093118] Xenomai: native: cleaning up pipe "crob_error" (ret=0).
Mar 23 17:14:38 suzuki kernel: [ 5819.093125] Xenomai: native: cleaning up pipe "crob_cmd_in" (ret=0).
Mar 23 17:14:38 suzuki kernel: [ 5819.093133] Xenomai: native: cleaning up pipe "crob_display_out" (ret=0).
Mar 23 17:14:38 suzuki kernel: [ 5819.093140] Xenomai: native: cleaning up pipe "crob_tick" (ret=0).
```


However, the `-3` error code makes no sense: I don't understand where it comes from. It is not part of the error code list for `rt_pipe_read()`, but instead seems to be `ESRCH`, "no such process".

In a wave of desperation, if I let the robot continue in spite of this error:

```
Mar 23 17:27:19 suzuki kernel: [ 6580.299174] Xenomai: native: cleaning up pipe "crob_error" (ret=0).
Mar 23 17:27:19 suzuki kernel: [ 6580.299187] Xenomai: native: cleaning up pipe "crob_cmd_in" (ret=0).
Mar 23 17:27:19 suzuki kernel: [ 6580.299194] Xenomai: native: cleaning up pipe "crob_display_out" (ret=0).
Mar 23 17:27:19 suzuki kernel: [ 6580.299201] Xenomai: native: cleaning up pipe "crob_tick" (ret=0).
Mar 23 17:27:19 suzuki imt-robot[7517]: fifo.c:149 -3 return from rt_pipe_read()
Mar 23 17:27:20  imt-robot[7517]: last message repeated 199 times
Mar 23 17:27:20 suzuki rsyslogd-2177: imuxsock begins to drop messages from pid 7517 due to rate-limiting
Mar 23 17:27:25 suzuki rsyslogd-2177: imuxsock lost 1921 messages from pid 7517 due to rate-limiting
Mar 23 17:27:25 suzuki imt-robot[7517]: fifo.c:149 -3 return from rt_pipe_read()
Mar 23 17:27:25  imt-robot[7517]: last message repeated 199 times
Mar 23 17:27:25 suzuki rsyslogd-2177: imuxsock begins to drop messages from pid 7517 due to rate-limiting
Mar 23 17:27:31 suzuki rsyslogd-2177: imuxsock lost 2200 messages from pid 7517 due to rate-limiting
Mar 23 17:27:31 suzuki imt-robot[7517]: fifo.c:149 -3 return from rt_pipe_read()
Mar 23 17:27:31  imt-robot[7517]: last message repeated 199 times
Mar 23 17:27:31 suzuki rsyslogd-2177: imuxsock begins to drop messages from pid 7517 due to rate-limiting
Mar 23 17:27:37 suzuki rsyslogd-2177: imuxsock lost 2200 messages from pid 7517 due to rate-limiting
Mar 23 17:27:37 suzuki imt-robot[7517]: fifo.c:149 -3 return from rt_pipe_read()
Mar 23 17:27:37  imt-robot[7517]: last message repeated 199 times
Mar 23 17:27:37 suzuki rsyslogd-2177: imuxsock begins to drop messages from pid 7517 due to rate-limiting
Mar 23 17:27:43 suzuki rsyslogd-2177: imuxsock lost 2200 messages from pid 7517 due to rate-limiting
Mar 23 17:27:43 suzuki imt-robot[7517]: fifo.c:149 -3 return from rt_pipe_read()
Mar 23 17:27:43  imt-robot[7517]: last message repeated 199 times
Mar 23 17:27:43 suzuki rsyslogd-2177: imuxsock begins to drop messages from pid 7517 due to rate-limiting
Mar 23 17:27:49 suzuki rsyslogd-2177: imuxsock lost 2200 messages from pid 7517 due to rate-limiting
Mar 23 17:27:49 suzuki imt-robot[7517]: fifo.c:149 -3 return from rt_pipe_read()
Mar 23 17:27:49  imt-robot[7517]: last message repeated 199 times
Mar 23 17:27:49 suzuki rsyslogd-2177: imuxsock begins to drop messages from pid 7517 due to rate-limiting
Mar 23 17:27:55 suzuki rsyslogd-2177: imuxsock lost 2200 messages from pid 7517 due to rate-limiting
Mar 23 17:27:55 suzuki imt-robot[7517]: fifo.c:149 -3 return from rt_pipe_read()
Mar 23 17:27:55  imt-robot[7517]: last message repeated 199 times
Mar 23 17:27:55 suzuki rsyslogd-2177: imuxsock begins to drop messages from pid 7517 due to rate-limiting
Mar 23 17:28:01 suzuki rsyslogd-2177: imuxsock lost 2200 messages from pid 7517 due to rate-limiting
Mar 23 17:28:01 suzuki imt-robot[7517]: fifo.c:149 -3 return from rt_pipe_read()
Mar 23 17:28:01  imt-robot[7517]: last message repeated 199 times
Mar 23 17:28:01 suzuki rsyslogd-2177: imuxsock begins to drop messages from pid 7517 due to rate-limiting
Mar 23 17:28:07 suzuki rsyslogd-2177: imuxsock lost 2200 messages from pid 7517 due to rate-limiting
Mar 23 17:28:07 suzuki imt-robot[7517]: fifo.c:149 -3 return from rt_pipe_read()
Mar 23 17:28:07  imt-robot[7517]: last message repeated 199 times
Mar 23 17:28:07 suzuki rsyslogd-2177: imuxsock begins to drop messages from pid 7517 due to rate-limiting
Mar 23 17:28:13 suzuki rsyslogd-2177: imuxsock lost 2200 messages from pid 7517 due to rate-limiting
Mar 23 17:28:13 suzuki imt-robot[7517]: fifo.c:149 -3 return from rt_pipe_read()
```




Now I'm starting to think that the issues arise when the child process starts somehow?

```
Mar 24 14:04:26 nixsys imt-robot[17076]: -- Initialising the robot.
Mar 24 14:04:26 nixsys imt-robot[17076]: Cleaned up FIFOs (cleanup_fifos)
Mar 24 14:04:26 nixsys imt-robot[17076]: init_fifos: done
Mar 24 14:04:26 nixsys imt-robot[17076]: Starting robot realtime process.
Mar 24 14:04:26 nixsys imt-robot[17076]: Process id of child process 17077 
Mar 24 14:04:26 nixsys imt-robot[17077]: fifo.c:151 -3 return from rt_pipe_read(), which I believe is --3
Mar 24 14:04:26 nixsys imt-robot[17077]: write.c:177 -3 return from rt_pipe_write()
Mar 24 14:04:26 nixsys imt-robot[17077]: Cleaned up FIFOs (cleanup_fifos)
Mar 24 14:04:26 nixsys imt-robot[17077]: Stopping robot realtime process (got signal 0).
Mar 24 14:04:26 nixsys imt-robot[17077]: Exited the child.
```


If I disable the function that calls the pipe read, i.e. `handle_fifo_input()` then the robot stays alive, but I have no idea whether it does what it should.
Here is what the log looks like:

```
Mar 24 17:39:27 nixsys imt-robot[19971]: -- Initialising the robot.
Mar 24 17:39:27 nixsys imt-robot[19971]: Cleaned up FIFOs (cleanup_fifos)
Mar 24 17:39:27 nixsys imt-robot[19971]: init_fifos: done
Mar 24 17:39:27 nixsys imt-robot[19971]: Starting robot realtime process.
Mar 24 17:39:27 nixsys imt-robot[19971]: Process id of child process 19972 
Mar 24 17:39:27 nixsys imt-robot[19972]: Pausing.
Mar 24 17:39:27 nixsys imt-robot[19972]: write.c:215 861 return from rt_pipe_write() message of length 861
Mar 24 17:39:28 nixsys imt-robot[19972]: write.c:215 -3 return from rt_pipe_write() message of length 431
Mar 24 17:39:28 nixsys imt-robot[19972]: message that was not written: <<[2]       1003 ms --- one_sample: top, i = 400, samples = 0, time since start = 1003 ms#012[4]       1003 ms ----- do_time_before_sample#012[3]       1005 ms ---- check_late#012[5]       1005 ms ------ check_late: assert not busy#012[3]       1005 ms ---- call_read_sensors#012[3]       1005 ms ---- call_read_reference#012[3]       1005 ms ---- compute_controls#012[3]       1005 ms ---- call_check_safety#012[4]       1005 ms ----- do_time_after_sample#012>>
Mar 24 17:39:29 nixsys imt-robot[19972]: write.c:215 -3 return from rt_pipe_write() message of length 431
Mar 24 17:39:29 nixsys imt-robot[19972]: message that was not written: <<[2]       2003 ms --- one_sample: top, i = 800, samples = 0, time since start = 2003 ms#012[4]       2003 ms ----- do_time_before_sample#012[3]       2005 ms ---- check_late#012[5]       2005 ms ------ check_late: assert not busy#012[3]       2005 ms ---- call_read_sensors#012[3]       2005 ms ---- call_read_reference#012[3]       2005 ms ---- compute_controls#012[3]       2005 ms ---- call_check_safety#012[4]       2005 ms ----- do_time_after_sample#012>>
```

So these look like very respectable feedback, not giving any hint of something being wrong.





## Timer issues

Oddly, when I add `#include <native/timer.h>` then the robot runs only for 5ms and then fails.

You can also get info about the timer from the CLI:

```
cat /proc/xenomai/timer
```

For me this returns something like this:

```
status=on:setup=78:clock=350915393776992:timerdev=lapic:clockdev=tsc
```




## Summary of what I learned so far

The robot process is starting, but in 1-2 seconds dies. It dies by shutting itself down. What triggers this is that we can't read or write to pipes anymore, giving us error code `-3`. After this time no read or write succeeds anymore except writing to `SYSLOG`, where I see a normal looking shut down procedure.

The reading is part of the code because it allows the robot to read from a command pipe where you can tell it to do things, other than having to pass through shared memory (shm). If I disable this, i.e. disable the function `handle_fifo_input();` then the robot no longer dies, but any reads or writes to any pipes still fail. Everything else seems to be working fine. When this process is running I can even go in and `wshm('quit',1)` and the robot will quit of its own accord... nice!

In addition to this, there seems to be something wrong with the time stamps that we get from Xenomai. I see that the loop is set up accurately at 400 Hz and indeed the millisecond time stamps reflect this (increments of 2-3 ms on every turn). However, the timestamps in nanoseconds or microseconds appear to be off.











## Another interesting observation

Suddenly ob->Hz goes to zero; this is when I print the syslog with horrendously verbose debug messaging:

```
Mar 24 07:54:51 nixsys imt-robot[12767]: ob->i 3.
Mar 24 07:54:51 nixsys imt-robot[12767]: ob->Hz 2.499977.
Mar 24 07:54:51 nixsys imt-robot[12767]: ob->debug_level 6.
Mar 24 07:54:51 nixsys imt-robot[12767]: level 4.
Mar 24 07:54:51 nixsys imt-robot[12767]: ob->i 3.
Mar 24 07:54:51 nixsys imt-robot[12767]: ob->Hz 11.472839.
Mar 24 07:54:51 nixsys imt-robot[12767]: ob->debug_level 6.
Mar 24 07:54:51 nixsys imt-robot[12767]: level 0.
Mar 24 07:54:51 nixsys imt-robot[12767]: ob->i 3.
Mar 24 07:54:51 nixsys imt-robot[12767]: ob->Hz 2.471199.
Mar 24 07:54:51 nixsys imt-robot[12767]: ob->debug_level 6.
Mar 24 07:54:51 nixsys imt-robot[12767]: level 0.
Mar 24 07:54:51 nixsys imt-robot[12767]: ob->i 3.
Mar 24 07:54:51 nixsys imt-robot[12767]: ob->Hz 2.471199.
Mar 24 07:54:51 nixsys imt-robot[12767]: ob->debug_level 6.
Mar 24 07:54:51 nixsys imt-robot[12767]: level 0.
Mar 24 07:54:51 nixsys imt-robot[12767]: ob->i 3.
Mar 24 07:54:51 nixsys imt-robot[12767]: ob->Hz 2.471199.
Mar 24 07:54:51 nixsys imt-robot[12767]: ob->debug_level 6.
Mar 24 07:54:51 nixsys imt-robot[12767]: level 4.
Mar 24 07:54:51 nixsys imt-robot[12767]: ob->i 4.
Mar 24 07:54:51 nixsys imt-robot[12767]: ob->Hz 0.000000.
Mar 24 07:54:51 nixsys rsyslogd-2177: imuxsock begins to drop messages from pid 12767 due to rate-limiting
Mar 24 07:54:51 nixsys kernel: [74551.048450] IMT Robot Contr[12768]: segfault at 4002f994 ip 0804e446 sp 4026f1a0 error 4 in robot[8048000+11000]
```

**NOTE** Also, the Nixsys computer which doesn't have the PowerDAQ board gives the exact same sequence of events (and same error message).


