# Notes about the robot code

This is a collection of random notes relating to the InMotion2 robot code.


I set up Doxygen to generate a number of documentation pages in HTML straight from the C source code.

```
make doc
```



## Messages and logs
You can find some messages from the robot in `dmesg`. 

Also, you can look in `/var/log/syslog` for a variety of messages.

But somehow this is not where the debug messages go.
Debug messages are generated by calling `dpr()` in `write.c`, which seems to write to some buffer.

When the buffer is flushed (`dpr_flush()`) the contents are written to a pipe using `rt_pipe_write()`. The pipe is `ob->eofifo`, which is created in `fifo.c`. It seems that when you create these pipes using `rt_pipe_create()` you can give it a particular name (in our case these look like `crob_in` or `crob_error` and they are defined in `pipes.h`). Xenomai will then create a symbolic link `/proc/xenomai/registry/pipes/NAME` (where `NAME` is the string identifier) to a node `/dev/rtp*`.

Indeed, for example the logging procedure works by monitoring `/proc/xenomai/registry/pipes/crob_out` and pushing it to a file.

When monitoring `/dev/rtp[0-5]` I see various messages on `/dev/rtp2` when I run the robot (and before it dies).

Eavesdropping is easy: `sudo cat /dev/rtp2 > ~/rob_rtp2.txt` but you just need to make sure that you cut that pipe and restart it prior to launching the robot, otherwise it can't open the pipe for writing.

This is the kind of thing I am getting on `rtp2` (note that I had set the debug level to 5, the higest, I believe).

```
^@arr sum = 1867345481
carr sum = -574826563
carr sum = 1294923759
carr sum = 1839425361
carr sum = -501817148
carr sum = 1429687849
carr sum = -861162344
carr sum = -317643015
carr sum = 226727519
carr sum = 1993337521
carr sum = -2125963233
carr sum = -172895626
carr sum = 371210218
carr sum = 1463857484
carr sum = -1129114182
carr sum = 503789105
carr sum = -1939037025
carr sum = -102627839
carr sum = 1764036619
carr sum = -761820805
carr sum = -217320990
carr sum = 641475092
carr sum = -1700107468
carr sum = -32776807
carr sum = 1669482253
carr sum = -672033747
carr sum = -127925354
carr sum = 1623419114
carr sum = -802170792
carr sum = 1133855167
carr sum = -1310826005
carr sum = -186085298
carr sum = 1732967855
carr sum = -860724712
carr sum = 234848836
carr sum = 1632936560
carr sum = -709055311
carr sum = 83303717
carr sum = 2087621716
carr sum = -253952638
carr sum = 1413378023
carr sum = -1179330213
carr sum = 774129288
carr sum = 1553118705
carr sum = 1728062804
carr sum = -2022927979
carr sum = -271320313
carr sum = 1643409019
carr sum = -732306976
carr sum = -557955242
carr sum = -557955232
return from main_init
Starting robot realtime process.
main: calling pthread_create start_routine
start_routine: top of thread, 400 Hz
main_loop: top, i = 0, samples = 0, time since start = 0 ms
do_time_before_sample
check_late
check_late: assert not busy
check_late: warning: slow tick.  time = 1435 ms, i = 0 ticks
        tick took 1435106589 ns > threshold (120%)
call_read_sensors
call_read_reference
compute_controls
call_check_safety
do_time_after_sample
after_sample: warning: slow sample.  time = 1435 ms, i = 0 ticks
        sample took 1793877800 ns, > threshold (10%)
		
```


First of all, I have no idea what these `carr sum` statements are for. I can't see that `carr` is used anywhere else.

Second, it seems that the robot finds that its main loop is too slow, perhaps this is why it quits?





This is curious because Xenomai itself appears to be working properly, with microsecond resolution.

```
== Sampling period: 100 us
== Test mode: periodic user-mode task
== All results in microseconds
warming up...
RTT|  00:00:01  (periodic user-mode task, 100 us period, priority 99)
RTH|----lat min|----lat avg|----lat max|-overrun|---msw|---lat best|--lat worst
RTD|      1.037|      1.053|      1.831|       0|     0|      1.037|      1.831
RTD|      0.695|      1.000|      1.777|       0|     0|      0.695|      1.831
RTD|      0.964|      1.046|      1.783|       0|     0|      0.695|      1.831
RTD|      0.784|      1.028|      1.726|       0|     0|      0.695|      1.831
RTD|      0.962|      1.044|      1.836|       0|     0|      0.695|      1.836
RTD|      0.830|      1.025|      1.852|       0|     0|      0.695|      1.852
RTD|      0.962|      1.009|      1.825|       0|     0|      0.695|      1.852
RTD|      0.828|      1.025|      2.113|       0|     0|      0.695|      2.113
RTD|      0.962|      1.038|      1.798|       0|     0|      0.695|      2.113
RTD|      0.827|      1.050|      1.830|       0|     0|      0.695|      2.113
RTD|      0.965|      1.036|      1.875|       0|     0|      0.695|      2.113
RTD|      0.861|      1.017|      1.758|       0|     0|      0.695|      2.113
RTD|      0.964|      1.024|      1.831|       0|     0|      0.695|      2.113
RTD|      0.829|      1.045|      1.790|       0|     0|      0.695|      2.113
RTD|      0.963|      1.045|      1.782|       0|     0|      0.695|      2.113
RTD|      0.842|      1.044|      1.783|       0|     0|      0.695|      2.113
RTD|      0.962|      1.027|      1.818|       0|     0|      0.695|      2.113
RTD|      0.960|      1.009|      2.151|       0|     0|      0.695|      2.151
RTD|      0.967|      1.051|      1.826|       0|     0|      0.695|      2.151
RTD|      0.867|      1.041|      1.725|       0|     0|      0.695|      2.151
RTD|      0.964|      1.054|      1.781|       0|     0|      0.695|      2.151
RTT|  00:00:22  (periodic user-mode task, 100 us period, priority 99)
RTH|----lat min|----lat avg|----lat max|-overrun|---msw|---lat best|--lat worst
RTD|      0.965|      1.046|      2.097|       0|     0|      0.695|      2.151
RTD|      0.966|      1.043|      1.808|       0|     0|      0.695|      2.151
RTD|      0.847|      1.011|      3.048|       0|     0|      0.695|      3.048
RTD|      0.964|      1.045|      1.844|       0|     0|      0.695|      3.048
RTD|      0.828|      1.027|      1.774|       0|     0|      0.695|      3.048
RTD|      0.965|      1.044|      1.828|       0|     0|      0.695|      3.048
RTD|      0.850|      1.032|      1.819|       0|     0|      0.695|      3.048
RTD|      0.959|      1.007|      1.910|       0|     0|      0.695|      3.048
RTD|      0.752|      0.996|      1.818|       0|     0|      0.695|      3.048
RTD|      0.952|      1.040|      2.709|       0|     0|      0.695|      3.048
RTD|      0.827|      1.050|      1.803|       0|     0|      0.695|      3.048
RTD|      0.962|      1.035|      1.877|       0|     0|      0.695|      3.048
RTD|      0.865|      1.044|      1.837|       0|     0|      0.695|      3.048
RTD|      0.962|      1.014|      2.188|       0|     0|      0.695|      3.048
RTD|      0.860|      1.045|      1.877|       0|     0|      0.695|      3.048
RTD|      0.960|      1.025|      1.791|       0|     0|      0.695|      3.048
RTD|      0.852|      1.043|      1.850|       0|     0|      0.695|      3.048
RTD|      0.964|      1.026|      1.830|       0|     0|      0.695|      3.048
^C---|-----------|-----------|-----------|--------|------|-------------------------
RTS|      0.695|      1.033|      3.048|       0|     0|    00:00:39/00:00:39
```
